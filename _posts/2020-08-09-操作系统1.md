---
title: 操作系统1
tags:
 - 计科所学
---

## 概述

An operating system is a program that acts as an interface between the user and the computer hardware and controls the execution of all kinds of programs.

操作系统是什么？

- 实际上是一个程序，在用户接触硬件资源的过程中扮演了一个接口的角色并且控制了程序的执行过程（实际上就是对CPU资源的控制），总结来说操作系统就是对计算机各种资源进行统一管理的程序。
- 管理的方面包括：
  - 内存管理（管理对内存（主存）资源的使用）
  - 处理器管理（管理对CPU资源的使用，特别是多处理的系统中）
  - 设备管理（管理对各种外部设备的使用：I/O，键盘，声卡，网卡等等，通过驱动（drivers）来管理）
  - 文件管理（对信息存储和获取的方式的管理）
    - 文件系统通过组织成目录：为了方便导航和使用。
      - 跟踪信息，定位，使用，状态等等，这些构成的整体成为文件系统；
  - 其他功能：
      - 安全性管理（访问权限资源的管理）
      - 控制系统性能：
        - 记录服务请求和系统响应之间的延迟
      - 作业统计：
        - 跟踪各种作业和用户使用的时间和资源
      - 错误检查工具

## 硬件资源

什么是硬件资源？

> 即物理实实在在存在的资源，比如声卡、网卡、显卡、键盘的输入、物理磁盘、CPU资源等等。
>
> 举例：显卡资源的利用，显示图像啊；网卡：接受和发送来自/去往网络的信息，磁盘资源存储信息。

如今的计算机架构

> [冯诺依曼体系架构](https://zh.wikipedia.org/wiki/冯·诺伊曼结构)：
>
> - 也称存储程序型电脑。把指令当成一种特别类型的静态数据，一台存储型电脑可轻易改变其程序，并在程序下改变其运算内容。
> - 把 CPU 与存储器分来，CPU 根据指令的不同来负责四种基本动作：
>   - 处理器-存储器之间传送数据
>   - 处理器-I/O 之间传送数据
>   - 数据处理：执行很多与数据相关的算术操作和逻辑操作
>   - 控制：跳转，影响下一次取值的地址（PC 的值）

计算机主要有 4 个结构化部件：

> - 处理器（Processor)：运算器和控制器。
> - 内存(Main memory)
> - 输入/输出模块(I/O)
> - 系统总线(System bus)：
>   
>   - [系统总线](https://zh.wikipedia.org/wiki/系統匯流排)：**系统总线**（英语：**System Bus**）是一个单独的电脑[总线](https://zh.wikipedia.org/wiki/匯流排)，是连接电脑系统的主要组件。这个技术的开发是用来降低成本和促进[模块化](https://zh.wikipedia.org/wiki/模組化)。系统总线结合[数据总线](https://zh.wikipedia.org/wiki/資料匯流排)的功能来搭载信息，[地址总线](https://zh.wikipedia.org/wiki/位址匯流排)来决定将信息送往何处，[控制总线](https://zh.wikipedia.org/wiki/控制匯流排)来决定如何动作。虽然系统总线于1970年代至1980年代广受欢迎，但是现代的电脑却使用不同的分离总线来做更多特定需求用途。
>   
>   - 1）总线周期：总线上两个部件完成一次完整且可靠的数据传输时间； 2）总线周期分为四个阶段： 
>     - 申请分配阶段：申请总线 
>     - 寻址阶段：发出地址及有关命令 
>     - 传数阶段：进行数据交换 
>     - 结束：从总线上撤除信号，让出总线
>
> 模块化视图如下：
>
> 处理器的一种功能就是与存储器交换数据。使用两个内部（对处理器而言）寄存器：存储器地址寄存器：明确下一次读/写的存储器地址；存储器缓冲寄存器：存放要写入存储器的数据或从存储器读取数据。同理，还有指定特定的输入/输出设备的缓冲寄存器，用于在输入/输出模块和处理器间交换数据。
>
> ![image-20200813095615509](../assets/image/image-20200813095615509.png)
>
> 

中断：

> 中断是指：计算机提供的允许**其他模块**（I/O、寄存器）中断**处理器**正常处理过程的机制。即其他模块发送一个请求给处理器，处理器暂停当前任务的过程。中断不是程序调用过程中的一个例程，它可以在任何时候发生，因而可以在用户执行过程中任何一点发生，不可预测。
>
> 中断的简单分类：
>
> ![image-20200813102042705](../assets/image/image-20200813102042705.png)

引入中断程序的指令周期

> ![image-20200813102404636](../assets/image/image-20200813102404636.png)

存储器的层次结构

> 局部性原理：
>
> - 时间局部性：同一个数据，在一段时间内，可能会被多次访问。
> - 空间局部性：如果某个数据被访问，那么与它相邻的数据项很可能也将被访问。

高速缓存

> 在处理器和内存之间提供一个容量很小但速度很快的存储器，称之为高速缓存。

直接内存存取 DMA

> 执行 I/O 操作的技术有三种：可编程 I/O、中断驱动 I/O 和直接内存存取（DMA）。
>
> - 可编程 I/O
>   - 处理器执行程序时遇到一个 I/O 相关的指令时，它会通过相应的 I/O 模块发送命令来执行这个命令。使用可编程I/O操作时，I/O 模块执行请求的动作并设置 I/O 状态寄存器中的相应的位，但它并不会进一步通知处理器，尤其**不会中断处理器**。因此处理器需要在执行 I/O 指令后，还要**定期检查** I/O 模块的状态，以确定 I/O 操作是否完成。
> - 中断驱动 I/O
>   - 处理器给 I/O 模块发送 I/O 命令，然后处理器继续做其他一些有用的工作。当 I/O 模块准备好与处理器交换数据时，它将打断处理器的执行并请求服务。处理器和前面一样执行数据传送，然后恢复处理器以前的执行过程。
>
> 以上两种 I/O 都需要处理器参与数据的传送，有两方面的固有缺陷：
>
> - I/O 传送速度受限于处理器测试设备和提供服务的速度
> - 处理器忙于管理 I/O 传送的工作，必须执行很多指令以完成 I/O 传送
>
> 需要移动大量数据时，有一种更有效的技术为：直接内存存取(Direct Memory Access)。
>
> DMA 功能可以由**系统总线**中的一个**独立模块**完成，也可以并入 I/O 模块。该技术的工作方式如下：
>
> - 在处理器读或写一块数据时，给 DMA 模块产生一条命令，发送以下信息：
>   - 是否请求一次读或写
>   - 所涉 I/O 设备的地址
>   - 开始读或写的存储器单元
>   - 需要读或写的字数
> - 之后处理器继续执行其他工作。处理器直接把这个操作委托给 DMA 模块负责处理。DMA　模块直接与存储器交互，传送整个数据块，每次传送一个字。这个过程不需要处理器参与，传送完成后，DMA 模块向处理器发送一个中断信号。因此，只有开始传送和结束传送的时候，处理器才会参与。
>
> 但是，DMA 模块需要控制总线来与存储器进行数据传送。由于总线的使用中存在竞争，当处理器需要使用总线时，要等待 DMA 模块。这并不是一个中断，处理器没有保存上下文环境去做其他事情，而只是暂停一个总线周期（总线上传输一个字的时间）。因此，在 DMA 传送过程中，当处理器需要访问总线时，处理器执行速度会变慢。

## 操作系统发展历史

- 串行处理

- 简单批处理系统（第一个操作系统）

  - 一个监控程序的软件。操作员把作业按顺序组织成批，并将整个批作业放在输入设备伤，供监控程序使用。每个程序完成处理后返回到监控程序，同时监控程序自动加载下一个程序。

    执行过程：监控程序 控制权 =》用户程序，执行完毕 控制权 =》监控程序

    目的：充分利用处理器资源，没有任何空闲时间（不需要每次额外准备作业的时间）。但是如果程序有长时间 I/O 操作的话，还是会浪费资源。

- 多道批处理系统

  - 简单批处理系统的一个改进：操作系统内部多保留几个程序，当一个程序进行 I/O 操作时，切换另一个程序来运行。

- 分时系统
  - 多个用户共享处理器的时间，分时技术。多个用户通过终端访问系统，操作系统在每个用户程序中**很短的时间交替**执行。
  - 本质是利用人的反应时间比计算机响应时间慢许多的特点

- 现代操作系统
  
  - Linux, Windows, Mac OS, 分布式操作系统 etc.

## 进程

为什么要有进程这个概念？设计这样概念的目的是什么？

> 这个问题不好回答，我想等我复习完之后，我再回答或者逐渐补全回答：
>
> - 目的之一：**表征**（用来描述）一个正在执行的程序
> - 目的之二：**操作系统**为每个要执行的程序创建进程，利用进程达到**控制程序**的执行的效果

进程是什么？它由什么构成？

> 是对执行的程序的一种抽象表达：程序执行的实体称之为进程：即一个正在执行（注意是执行）的程序。
>
> 基本构成：
>
> - **程序代码**和与之关联的**数据集**
>
> - 可以用如下元素来表征一个进程
>
>   - 标识符：PID
>   - 状态：运行，阻塞等等
>   - 优先级：相对于其他进程的优先顺序
>   - 程序计数器：PC
>   - 内存指针：包括程序代码和进程相关数据的指针，以及与其他进程共享内存块的指针
>   - 上下文数据：进程执行时处理器的寄存器的数据
>   - I/O 状态信息：显示 I/O 请求，分配给进程的 I/O 设备和被进程使用的文件列表
>   - 记账信息：包括处理器的时间总和。
>
>   上述信息将放在一个称之为 PCB 的数据结构中。

### 进程模型

五状态进程模型

> - 新建态：程序对应的进程被创建，但是还没有加载至内存
> - 就绪态：进程做好了准备，只要有机会就会开始执行
> - 运行态：进程正在执行
> - 阻塞态：进程再某些事情发生前不能执行，比如等待 I/O 操作
> - 退出态：从可执行的进程组中释放出的进程
>
> ![image-20200813231048351](../assets/image/image-20200813231048351.png)

七状态进程模型

> ![image-20200814101549726](../assets/image/image-20200814101549726.png)

### 进程描述

为了管理进程和资源，必须掌握每个进程和资源的当前状态。普遍采用的方法是，操作系统构造并维护其管理的每个实体的信息表。**操作系统维护 4 种不同类型的表**：内存、I/O、文件和进程。其中这些表并不是独立的，它们之间以某种方式链接起来或交叉引用。

- 内存表
  - 分配给进程的内存
  - 分配给进程的外存
  - 内存块或虚存储块的任何保护熟悉，如哪些进程可以访问某些共享内存区域
  - 管理虚存所需要的任何信息
- I/O 表
  - 管理计算机系统中的 I/O 设备和通道。
- 文件表
  - 文件表提供文件是否存在、文件在外存中的位置、当前状态和其他属性的信息。
- 进程表
  - 管理进程的表
  - 进程映像( process image )：等价一个进程
    - 程序（代码）
    - 数据
    - 栈
    - 属性集合(PCB)
      - 进程标识信息：PID, 用户 ID
      - 进程状态信息：处理器的状态信息（寄存器等等）
      - 进程控制信息

### 进程创建

操作系统创建进程的一般步骤：

- 为新进程分配一个唯一的进程标识符。主进程表添加一个新表项，每个进程一个表项；
- 为进程分配空间。操作系统需要知道私有用户地址空间（程序和数据）和用户栈需要多少空间；
- 初始化进程控制块PCB。PC，系统栈指针等等。
- 设置正确的链接。比如若操作系统将每个调度队列都维护一个链表，则新进程必须在就绪或挂起链表中。
- 创建或扩充其他数据结构。比如维护一个记账文件。

### 进程切换

- 将程序计时器置为中断处理程序的开始地址
- 从用户模式切换到内核模式
- 保存原先进程的状态：
  - 保存处理器上下文，包括寄存器，PC，栈指针等等
  - 更新当前处于运行态进程的PCB，比如更改里面的进程的状态
  - 把该进程的PCB表移到相应的队列
  - 选择另一个进程执行
  - 更新所选的 PCB, 比如状态改为运行态
  - 更新内存管理数据结构
  - 载入程序计数器和其他寄存器先前的值（换入的进程）

## 线程

为什么引入线程概念？

> 进程概念本身其实具有两个性质：一个与资源所有权（进程映像）相关，另一个与执行相关。为了区分这两个特点，引入线程来分离进程执行的特点。

进程和线程的定义？

> 在多线程环境下的定义：
>
> - 进程是操作系统**分配资源**的最小单元和**保护单元**
> - 线程是操作系统分派执行的最小单元

进程和线程的特点？

> 进程，和之前构成无区别：
>
> - 容纳进程映像的虚拟地址空间
> - 对处理器、其他进程（通信）、文件和 I/O 资源的受保护访问
>
> 线程的构成
>
> - 一个线程执行状态(运行、就绪等)
> - 为运行时保存的线程上下文；线程可视为在进程内的一个**独立的程序计数器**
> - 一个**执行栈**
> - 每个线程用于**局部变量**的一些**静态存储空间**
> - 与进程内其他线程**共享的内存和资源访问**

线程与进程相比有什么优缺点？

> - 在已有的进程中创建一个新线程的时间远远少于创建一个全新进程的时间：
>
>   - 创建进程需要创建PCB表项，需要分配较多的地址空间（代码，栈区等等）；还需要设置诸多控制访问信息：文件信息，I/O 控制访问信息等等；
>
>   - 而创建线程轻量许多：只需要重新分配一个栈空间，一个新的PC（程序计数器），线程控制块中信息比进程控制块中少很多，比如控制访问信息可以不需要。
>
> - 销毁也是线程占优势：
>
>   - 线程
>     - 释放栈空间
>     - 释放线程控制块
>
> - 切换也是线程占优：
>
>   - 进程
>   - 线程：
>     - 把当前 PC 指向切换程序的首地址
>     - 保存当前线程的处理器的上下文信息：寄存器信息（包含了栈指针），PC 信息
>     - 更新线程控制块的信息，比如线程的状态变为阻塞态
>     - 把新的线程的上下文信息载入
>     - 更改 PC 为当前线程的指令地址
>
> - 线程之间的通信效率更高：因为共享地址空间，可以通过共享内存实现通信；而进程需要更为复杂的通信机制：管道，消息队列，套接字等等
>
> - 进程的安全性较高。因为不同的进程隔离在不同的地址空间中运行，所以安全性较高。

线程的分类：

> 用户级线程：就是用户管理所有的线程的创建，切换等等
>
> 内核级线程：内核直接管理线程。